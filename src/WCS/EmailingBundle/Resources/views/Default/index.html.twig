{% extends 'TobookBundle::base.html.twig' %}

{% block body %}

{% for etablissement in liste_etablissements %}

	<div>
		{{ etablissement.usprProfId.profNom }}</br>
		<a href="{{ path('wcs_emailing_import', { 'profCode': etablissement.usprProfId.profCode }) }}">{{ "Ajouter des clients (fichier csv)"|trans }}</a>
	</div>

    <div class="container">
        <table id="clientTable" class="display" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th>{{ "Email"|trans }}</th>
                    <th>{{ "Nom"|trans }}</th>
                    <th>{{ "Prénom"|trans }}</th>
                    <th>{{ "Adresse"|trans }}</th>
                    <th>{{ "Ville"|trans }}</th>
                    <th>{{ "Pays"|trans }}</th>
                    <th>{{ "Genre"|trans }}</th>
                    <th>{{ "CSP"|trans }}</th>
                </tr>
            </thead>
            <tbody>    
                {% for key, client in client if client.emaiProfId == etablissement.usprProfId %}
                    <tr id="{{ key }}" data-info="{{ client.emaiEmail }}">
                        <td>{{ client.emaiEmail }}</td> <!--email-->
                        <td>{{ client.emaiNom }}</td> <!--nom-->
                        <td>{{ client.emaiPrenom }}</td> <!--prénom-->
                        <td>{{ client.emaiAdresse }}</td> <!--adresse-->
                        <td>{{ client.emaiVille }}</td> <!--ville-->
                        <td>{{ client.emaiPays }}</td> <!--pays-->
                        <td>{{ client.emaiGenre }}</td> <!--genre-->
                        <td>{{ client.emaiCSP }}</td> <!--csp-->
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <input id="suppr" type="button" value="{{ "Supprimer sélection"|trans }}" />
        <input id="envoi" type="button" value="{{ "Valider"|trans }}" />
    </div> <!--container-->
	
    <form method="post" action="{{ path ('send_mail') }}">
      <input id ="{{ etablissement.usprProfId.profCode }}" name="destinataire" placeholder="destinataire" value="">
      <input name="sujet" placeholder "sujet">
      <textarea name="message" placeholder="contenu du message"></textarea>
      <input type="submit">
    </form>

<style>
/*display none du nb de sélection du tableau, affichage erroné quand on fait un select avec shift*/
.dataTables_info span {
    display: none;
}
</style>

<script>
$(document).ready(function() {
    
    // stylisation du datatable avec selection multiple sans pagination et avec scroll
    $('#clientTable').DataTable( {
        select: {
            style: 'multi'
        },
        scrollY:        "200px",
        scrollCollapse: true,
        paging:         false,
    } );

    var profCode = "{{ etablissement.usprProfId.profCode }}";
    var arraymsg = [];
    var lastSelected;
    $('tr').click(function(event) {
        
        // récupère l'id du tr sélectionné
        idtr = this.id;
        // récupère le data-info du tr sélectionné
        var datainfo = $('#'+idtr).data('info');
        var tableRow = $(this).closest('tr').prevAll('tr').length + 1;

        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            arraymsg.pop(datainfo);
        } else if (event.shiftKey) {
            var table = $('#clientTable');
            var start = Math.min(tableRow, lastSelected);
            var end = Math.max(tableRow, lastSelected);
            for (var i = start+1; i < end+1; i++) {
                table.find('tr').eq(i).addClass('selected');
                arraymsg.push(table.find('tr').eq(i).data('info')); 
            } 
        } else {
            $(this).addClass('selected');
            arraymsg.push(datainfo);
            lastSelected = $(this).closest('tr').prevAll('tr').length + 1;       
        }
    });

    // fonction permettant d'envoyer la sélection des lignes vers l'email (join permet de passer d'un tableau à un string)
    $('#envoi').click(function() {
        $("#"+profCode).val( function( index, val ) {
            return val + arraymsg.join();
        });
    });

    // fonction permettant la suppression de la sélection
    $('#suppr').click(function() {
        var table = $('#clientTable');
        table.find('tr').removeClass('selected');
        arraymsg = [];
    });

} );

</script>

{% endfor %}

{% endblock %}